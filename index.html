<!DOCTYPE html>
<html>
<head>
  <title>Roblox UI Builder (Mobile Friendly)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="stylesheet" href="./libs/gpickr.min.css">
  <script src="./libs/interact.min.js"></script>
  <script src="./libs/gpickr.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }
    .preview {
      border: 1px solid #aaa;
      width: 100%;
      max-width: 500px;
      height: 400px;
      position: relative;
      background: #f4f4f4;
      touch-action: none; /* important for touch dragging */
    }
    .ui-element {
      position: absolute;
      border: 1px solid #444;
      background: rgba(0,0,0,0.1);
      touch-action: none;
      box-sizing: border-box;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      overflow: hidden;
      user-select: none;
    }
    .selected-border {
      outline: 2px solid blue;
    }
    #explorer {
      width: 100%;
      max-width: 220px;
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: auto;
      background: #fff;
      padding: 5px;
      -webkit-overflow-scrolling: touch;
    }
    .explorer-item {
      padding: 4px 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      user-select: none;
      font-size: 14px;
    }
    .explorer-item.selected {
      background: #def;
    }
    .toggle, .icon {
      width: 18px;
      text-align: center;
      user-select: none;
    }
    #panel {
      width: 100%;
      max-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      font-size: 12px;
    }
    .context-menu {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      z-index: 10000;
      font-size: 14px;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      border-radius: 3px;
    }
    .context-menu div {
      padding: 6px 12px;
      cursor: pointer;
    }
    .context-menu div:hover {
      background: #eee;
    }
    #modeButtons {
      margin: 8px 0;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      flex: 1;
      padding: 8px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #666;
      background: #eee;
      user-select: none;
      -webkit-user-select: none;
    }
    button:active {
      background: #ccc;
    }
  </style>
</head>
<body>

<div style="flex:1; min-width: 280px; max-width: 500px;">
  <h2>UI Builder</h2>
  <label style="font-size: 16px; user-select:none;">
    Type:
    <select id="instanceType" style="font-size: 16px; padding: 4px; margin-left: 8px;">
      <option>Frame</option>
      <option>TextLabel</option>
      <option>TextButton</option>
      <option>ImageLabel</option>
      <option>Folder</option>
      <option>Model</option>
    </select>
  </label>
  <button onclick="addElement()">Add Element</button>
  <div id="modeButtons">
    <button onclick="setMode('move')">üîÄ Move</button>
    <button onclick="setMode('resize')">üìê Resize</button>
  </div>
  <div class="preview" id="preview" onclick="clearSelection()"></div>
</div>

<div id="explorer">
  <b>Explorer</b><br>
  <div id="explorerList" onclick="clearSelection()"></div>
</div>

<div id="panel">
  <h3>Properties</h3>
  <div id="propFields"></div>
  <button onclick="applyProperties()">Apply</button>
  <h3>Lua Code</h3>
  <textarea id="output" readonly></textarea>
</div>

<script>
let idCounter = 0, selected = null, currentParent = null, clipboard = null, mode = 'move';
const typeProps = {
  Frame:['Name','Left','Top','Width','Height','Color'],
  TextLabel:['Name','Left','Top','Width','Height','Color','Text'],
  TextButton:['Name','Left','Top','Width','Height','Color','Text'],
  ImageLabel:['Name','Left','Top','Width','Height','Color','Image'],
  Folder:['Name'],
  Model:['Name']
};

function addElement(){
  const t = document.getElementById('instanceType').value;
  idCounter++;
  const e = document.createElement('div');
  e.className = 'ui-element';
  Object.assign(e.dataset, {
    id: idCounter,
    type: t,
    name: `${t}${idCounter}`,
    parent: currentParent?.dataset.id || 'ScreenGui'
  });

  // Set default position & size or hide containers
  if(['Folder','Model'].includes(t)) {
    e.style.display = 'none'; // invisible container
  } else {
    e.style.cssText = 'left:50px; top:50px; width:100px; height:50px;';
  }
  ['color','text','image'].forEach(p => delete e.dataset[p]);

  e.addEventListener('click', ev => { ev.stopPropagation(); select(e,true); });

  document.getElementById('preview').appendChild(e);
  interactElement(e);
  refresh();
}

function clearSelection(){
  selected = null;
  currentParent = null;
  document.getElementById('propFields').innerHTML = '';
  updateHighlight();
}

function select(e, focusExplorer){
  selected = e;
  currentParent = e;
  renderProps();
  updateHighlight();
  if(focusExplorer) renderExplorer();
  generateCode();
}

function updateHighlight(){
  document.querySelectorAll('.ui-element').forEach(el => {
    el.classList.toggle('selected-border', el === selected);
  });
}

function renderProps(){
  const cont = document.getElementById('propFields');
  cont.innerHTML = '';
  if(!selected) return;

  typeProps[selected.dataset.type].forEach(p => {
    const div = document.createElement('div');
    if(p === 'Color'){
      div.innerHTML = `
        <label style="display:flex; align-items:center; gap:8px;">
          ${p}: 
          <input id="prop${p}" type="text" style="flex:1; font-size:14px; padding:4px;" />
          <span id="colorPreview${p}" style="width:28px; height:28px; border:1px solid #000; cursor:pointer; border-radius:3px;"></span>
        </label>
      `;
      cont.appendChild(div);
      // Set input value and init gpickr
      const input = document.getElementById(`prop${p}`);
      input.value = selected.dataset.color || '255,255,255';

      // Clear any existing picker first if any
      if(window.colorPickr) window.colorPickr.destroy();

      window.colorPickr = Pickr.create({
        el: `#colorPreview${p}`,
        theme: 'nano',
        default: `rgb(${input.value})`,
        components: {
          preview: true,
          opacity: false,
          hue: true,
          interaction: {
            input: true,
            save: true
          }
        }
      });
      window.colorPickr.on('save', (color) => {
        const rgb = color.toRGBA().slice(0,3).map(c => Math.round(c)).join(',');
        selected.dataset.color = rgb;
        input.value = rgb;
        window.colorPickr.hide();
        generateCode();
      });
      // Also update preview box background color
      document.getElementById(`colorPreview${p}`).style.backgroundColor = `rgb(${input.value})`;

      input.oninput = () => {
        const val = input.value;
        if(/^(\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})$/.test(val)) {
          selected.dataset.color = val;
          document.getElementById(`colorPreview${p}`).style.backgroundColor = `rgb(${val})`;
          generateCode();
        }
      };
    } else {
      div.innerHTML = `<label>${p}: <input id="prop${p}" style="font-size:14px; padding:4px; width: 100%;"/></label>`;
      cont.appendChild(div);
      let val;
      if(['Left','Top','Width','Height'].includes(p)) {
        val = parseInt(selected.style[p.toLowerCase()]);
      } else {
        val = selected.dataset[p.toLowerCase()] || '';
      }
      document.getElementById('prop'+p).value = val;
    }
  });
}

function applyProperties(){
  if(!selected) return;
  typeProps[selected.dataset.type].forEach(p => {
    const input = document.getElementById('prop'+p);
    if(!input) return;
    const v = input.value;
    if(['Left','Top','Width','Height'].includes(p)) {
      selected.style[p.toLowerCase()] = v+'px';
    } else if (p === 'Color') {
      selected.dataset.color = v;
      document.getElementById(`colorPreview${p}`).style.backgroundColor = `rgb(${v})`;
    } else {
      selected.dataset[p.toLowerCase()] = v;
    }
  });
  refresh();
}

function renderExplorer(){
  const root = document.getElementById('explorerList');
  root.innerHTML = '';

  function build(pid, lvl){
    document.querySelectorAll('.ui-element').forEach(e => {
      if(e.dataset.parent === pid){
        const row = document.createElement('div');
        row.className = 'explorer-item' + (e === selected ? ' selected' : '');
        row.style.paddingLeft = (lvl * 12) + 'px';

        const toggle = document.createElement('span');
        toggle.className = 'toggle';
        if(['Folder','Model'].includes(e.dataset.type)){
          toggle.innerText = e.dataset._expanded ? '‚ñº' : '‚ñ∂';
          toggle.onclick = ev => {
            ev.stopPropagation();
            e.dataset._expanded = !e.dataset._expanded;
            renderExplorer();
          };
        } else {
          toggle.innerText = '';
          toggle.style.width = '16px';
        }
        row.appendChild(toggle);

        const ico = document.createElement('span');
        ico.className = 'icon';
        ico.innerText = {Frame:'‚òê',TextLabel:'T',TextButton:'‚Üø',ImageLabel:'üñº',Folder:'üìÅ',Model:'üì¶'}[e.dataset.type];
        row.appendChild(ico);

        const nameSpan = document.createElement('span');
        nameSpan.textContent = e.dataset.name;
        row.appendChild(nameSpan);

        row.onclick = () => select(e, false);
        row.oncontextmenu = ev => {
          ev.preventDefault();
          contextMenu(ev.clientX, ev.clientY, e);
        };

        root.appendChild(row);

        if(e.dataset._expanded) build(e.dataset.id, lvl + 1);
      }
    });
  }
  build('ScreenGui', 0);
}

function contextMenu(x, y, el){
  const menu = document.createElement('div');
  menu.className = 'context-menu';
  ['Cut','Copy','Paste','Rename','Delete'].forEach(cmd => {
    const item = document.createElement('div');
    item.innerText = cmd;
    item.onclick = () => {
      if(menu.parentNode) document.body.removeChild(menu);
      handleContext(cmd, el);
    };
    menu.appendChild(item);
  });
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  document.body.appendChild(menu);

  document.addEventListener('click', () => {
    if(menu.parentNode) document.body.removeChild(menu);
  }, { once:true });
}

function handleContext(cmd, el){
  if(cmd === 'Cut' || cmd === 'Copy') {
    clipboard = { el, mode: cmd.toLowerCase() };
  }
  if(cmd === 'Paste' && clipboard && selected) {
    if(clipboard.mode === 'cut') {
      clipboard.el.dataset.parent = selected.dataset.id;
    } else {
      const clone = clipboard.el.cloneNode(true);
      idCounter++; 
      clone.dataset.id = idCounter;
      clone.dataset.parent = selected.dataset.id;
      document.getElementById('preview').appendChild(clone);
      interactElement(clone);
    }
  }
  if(cmd === 'Rename') {
    const n = prompt('New Name:', el.dataset.name);
    if(n) el.dataset.name = n;
  }
  if(cmd === 'Delete') {
    if(el.parentElement) el.parentElement.removeChild(el);
    if(el === selected) selected = null;
  }
  refresh();
}

function setMode(m){
  mode = m;
  updateMode();
}

function updateMode(){
  document.querySelectorAll('.ui-element').forEach(el => {
    if(mode === 'move'){
      interact(el).draggable(true).resizable(false);
    } else {
      interact(el).draggable(false).resizable({
        edges: { bottom: true, right: true },
        restrictEdges: { outer: 'parent' }
      });
    }
  });
}

function interactElement(el){
  interact(el)
  .draggable({
    inertia: false,
    modifiers: [
      interact.modifiers.restrictRect({ restriction: 'parent' })
    ],
    listeners: {
      move(event) {
        const x = parseFloat(el.style.left) || 0;
        const y = parseFloat(el.style.top) || 0;
        el.style.left = (x + event.dx) + 'px';
        el.style.top = (y + event.dy) + 'px';
        if(el === selected) renderProps();
        generateCode();
      }
    },
    // support for mobile touch dragging
    autoScroll: true,
    ignoreFrom: 'input,textarea,select,button',
  })
  .resizable({
    edges: { bottom: true, right: true },
    inertia: false,
    modifiers: [
      interact.modifiers.restrictEdges({ outer: 'parent' }),
      interact.modifiers.restrictSize({ min: { width: 30, height: 20 } })
    ],
    listeners: {
      move(event) {
        el.style.width = event.rect.width + 'px';
        el.style.height = event.rect.height + 'px';
        if(el === selected) renderProps();
        generateCode();
      }
    }
  });
}

function generateCode(){
  let code = 'local ScreenGui = Instance.new("ScreenGui")\n\n';
  [...document.querySelectorAll('.ui-element')].forEach(e => {
    const nm = e.dataset.name.replace(/\s+/g, '_');
    const t = e.dataset.type;
    code += `local ${nm} = Instance.new("${t}")\n`;
    if(!['Folder','Model'].includes(t)){
      const l = parseInt(e.style.left) || 0;
      const tp = parseInt(e.style.top) || 0;
      const w = parseInt(e.style.width) || 100;
      const h = parseInt(e.style.height) || 50;
      const [r,g,b] = (e.dataset.color || '255,255,255').split(',').map(Number);
      code += `${nm}.Size = UDim2.new(0, ${w}, 0, ${h})\n`;
      code += `${nm}.Position = UDim2.new(0, ${l}, 0, ${tp})\n`;
      code += `${nm}.BackgroundColor3 = Color3.fromRGB(${r},${g},${b})\n`;
    }
    if(e.dataset.text && /Text(Label|Button)/.test(t)) code += `${nm}.Text = "${e.dataset.text}"\n`;
    if(e.dataset.image) code += `${nm}.Image = "rbxassetid://${e.dataset.image}"\n`;
    code += `${nm}.Parent = ${e.dataset.parent}\n\n`;
  });
  document.getElementById('output').value = code;
}

function refresh(){
  renderExplorer();
  updateHighlight();
  generateCode();
  updateMode();
}

document.getElementById('preview').addEventListener('click', clearSelection);

refresh();
</script>
</body>
</html>
