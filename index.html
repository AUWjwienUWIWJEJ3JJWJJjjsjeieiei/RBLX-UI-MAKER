<!DOCTYPE html>
<html>
<head>
  <title>Roblox UI Builder (Mobile Improved)</title>
  <script src="./libs/interact.min.js"></script>
  <link rel="stylesheet" href="./libs/gpickr.min.css" />
  <script src="./libs/gpickr.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
      margin: 0;
      height: auto;
      overflow-x: hidden;
    }

    .preview {
      border: 1px solid #aaa;
      width: 500px;
      height: 400px;
      position: relative;
      background: #f4f4f4;
      touch-action: none;
      user-select: none;
    }

    .ui-element {
      position: absolute;
      border: 1px solid #444;
      background: rgba(0, 0, 0, 0.1);
      touch-action: none;
      user-select: none;
    }

    .selected-border {
      outline: 2px solid blue;
    }

    #explorer {
      width: 220px;
      border: 1px solid #ccc;
      height: 400px;
      overflow: auto;
      background: #fff;
      padding: 5px;
      user-select: none;
    }

    .explorer-item {
      padding: 2px 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      user-select: none;
    }

    .explorer-item.selected {
      background: #def;
    }

    .toggle, .icon {
      width: 16px;
      text-align: center;
      user-select: none;
    }

    #panel {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    textarea {
      width: 100%;
      height: 200px;
    }

    .context-menu {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      z-index: 1000;
    }

    .context-menu div {
      padding: 4px 8px;
      cursor: pointer;
    }

    .context-menu div:hover {
      background: #eee;
    }

    #modeButtons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin: 8px 0;
    }

    button, select {
      padding: 8px;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
        padding: 10px;
        overflow-y: auto;
      }

      .preview {
        width: 100%;
        height: 300px;
      }

      #explorer, #panel {
        width: 100%;
        height: auto;
      }

      button, select {
        font-size: 16px;
        padding: 10px;
        width: 100%;
        margin-top: 5px;
      }

      #modeButtons button {
        width: 30%;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

  <h2>UI Builder</h2>
  <label>Type:
    <select id="instanceType">
      <option>Frame</option><option>TextLabel</option><option>TextButton</option>
      <option>ImageLabel</option><option>Folder</option><option>Model</option>
    </select>
  </label>
  <button onclick="addElement()">Add Element</button>

  <div id="modeButtons">
    <button onclick="setMode('none')">‚ùå None</button>
    <button onclick="setMode('move')">üîÄ Move</button>
    <button onclick="setMode('resize')">üìê Resize</button>
  </div>

  <div class="preview" id="preview"></div>

  <div id="explorer">
    <b>Explorer</b><br>
    <div id="explorerList" onclick="clearSelection()"></div>
  </div>

  <div id="panel">
    <h3>Properties</h3>
    <div id="propFields"></div>
    <button onclick="applyProperties()">Apply</button>
    <h3>Lua Code</h3>
    <textarea id="output" readonly></textarea>
  </div>

<script>
function refresh(){
  renderExplorer();
  generateCode();
}
let idCounter = 0, selected = null, currentParent = null, clipboard = null, mode = 'move';
let isDraggingOrResizing = false;

const typeProps = {
  Frame:['Name','Left','Top','Width','Height','Color'],
  TextLabel:['Name','Left','Top','Width','Height','Color','Text'],
  TextButton:['Name','Left','Top','Width','Height','Color','Text'],
  ImageLabel:['Name','Left','Top','Width','Height','Color','Image'],
  Folder:['Name'],
  Model:['Name']
};

const typeIcons = {
  Frame: '‚òê',
  TextLabel: 'T',
  TextButton: '‚Üø',
  ImageLabel: 'üñº',
  Folder: 'üìÅ',
  Model: 'üì¶'
};

function addElement(){
  const t = document.getElementById('instanceType').value; 
  idCounter++;
  const e = document.createElement('div'); 
  e.className='ui-element';

  const isVisual = !['Folder', 'Model'].includes(t);
  Object.assign(e.dataset,{
    id:idCounter,
    type:t,
    name:`${t}${idCounter}`
  });

  e.dataset.parent = (currentParent?.dataset?.id && currentParent.dataset.id !== e.dataset.id) ? currentParent.dataset.id : 'ScreenGui';

  if (isVisual) {
    e.style.cssText = 'left:50px; top:50px; width:100px; height:50px;';
    ['color','text','image'].forEach(p=>delete e.dataset[p]);
    e.addEventListener('click', ev=>{
      ev.stopPropagation();
      if (!isDraggingOrResizing) select(e,true);
    });
    document.getElementById('preview').appendChild(e);
    interactElement(e);
  }

  refresh();
}



function clearSelection(){
  if(isDraggingOrResizing) return;
  selected = null;
  currentParent = null;
  document.getElementById('propFields').innerHTML = '';
  updateHighlight();
}

function select(e, focusExplorer){
  if(isDraggingOrResizing) return;
  selected = e;
  currentParent = e;
  renderProps();
  updateHighlight();
  if(focusExplorer) renderExplorer();
  generateCode();
}

function updateHighlight(){
  document.querySelectorAll('.ui-element').forEach(el => {
    el.classList.toggle('selected-border', el === selected);
  });
}

function renderProps(){
  const cont = document.getElementById('propFields'); 
  cont.innerHTML = '';
  if (!selected) return;
  typeProps[selected.dataset.type].forEach(p => {
    const div = document.createElement('div');
    div.innerHTML = `<label>${p}: <input id="prop${p}" autocomplete="off" /></label>`;
    cont.appendChild(div);
    let val;
    if(['Left','Top','Width','Height'].includes(p)) val = parseInt(selected.style[p.toLowerCase()]) || 0;
    else val = selected.dataset[p.toLowerCase()] || '';
    document.getElementById('prop'+p).value = val;
  });
}

function applyProperties(){
  if(!selected) return;
  typeProps[selected.dataset.type].forEach(p => {
    const v = document.getElementById('prop'+p).value;
    if(['Left','Top','Width','Height'].includes(p)){
      if(!isNaN(parseInt(v))) selected.style[p.toLowerCase()] = v+'px';
    }
    else selected.dataset[p.toLowerCase()] = v;
  });
  refresh();
}

function renderExplorer(){
  const root = document.getElementById('explorerList'); 
  root.innerHTML = '';

  function build(pid, lvl){
    [...document.querySelectorAll('.ui-element,[data-type="Folder"],[data-type="Model"]')].forEach(e => {
      if (e.dataset.parent === pid) {
        const row = document.createElement('div');
        row.className = 'explorer-item'+(e===selected?' selected':'');
        row.style.paddingLeft = (lvl * 12) + 'px';

        const toggle = document.createElement('span');
        toggle.className = 'toggle';
        const hasChildren = [...document.querySelectorAll('[data-parent="'+e.dataset.id+'"]')].length > 0;

        if (hasChildren) {
          if (!e.dataset._expanded) e.dataset._expanded = 'false';
          toggle.innerText = (e.dataset._expanded === 'true') ? '‚ñº' : '‚ñ∂';
          toggle.onclick = ev => {
            ev.stopPropagation();
            e.dataset._expanded = (e.dataset._expanded === 'true') ? 'false' : 'true';
            renderExplorer();
          };
        } else {
          toggle.innerText = '';
        }
        row.appendChild(toggle);

        const ico = document.createElement('span');
        ico.className = 'icon';
        ico.innerText = typeIcons[e.dataset.type] || '?';
        row.appendChild(ico);

        const nameSpan = document.createElement('span');
        nameSpan.textContent = e.dataset.name;
        row.appendChild(nameSpan);

        row.onclick = () => {
          if (!isDraggingOrResizing) select(e, false);
        };
        row.oncontextmenu = ev => { 
          ev.preventDefault(); 
          contextMenu(ev.clientX, ev.clientY, e); 
        };
        root.appendChild(row);

        if (e.dataset._expanded === 'true') build(e.dataset.id, lvl + 1);
      }
    });
  }

  build('ScreenGui', 0);
}

function contextMenu(x, y, el){
  const menu = document.createElement('div');
  menu.className = 'context-menu';
  ['Cut','Copy','Paste','Rename','Delete'].forEach(cmd => {
    const item = document.createElement('div');
    item.innerText = cmd;
    item.onclick = () => {
      document.body.removeChild(menu);
      handleContext(cmd, el);
    };
    menu.appendChild(item);
  });
  menu.style.left = x+'px'; 
  menu.style.top = y+'px';
  document.body.appendChild(menu);
  document.addEventListener('click', () => { 
    if(menu.parentNode) document.body.removeChild(menu); 
  }, { once:true });
}

function handleContext(cmd, el){
  if(cmd==='Cut' || cmd==='Copy') clipboard = { el, mode:cmd.toLowerCase() };
  if(cmd==='Paste' && clipboard && selected){
    if(clipboard.mode==='cut') clipboard.el.dataset.parent = selected.dataset.id;
    else {
      const clone = clipboard.el.cloneNode(true);
      idCounter++; clone.dataset.id = idCounter;
      clone.dataset.name = clone.dataset.type + idCounter;
      clone.dataset.parent = selected.dataset.id;
      if (clone.classList.contains('ui-element')) {
        document.getElementById('preview').appendChild(clone);
        interactElement(clone);
      }
    }
  }
  if(cmd==='Rename'){
    const n = prompt('New Name:', el.dataset.name);
    if(n) el.dataset.name = n;
  }
  if(cmd==='Delete'){
    el.remove();
    if(el===selected) selected=null;
  }
  refresh();
}

function updateMode(){
  document.querySelectorAll('.ui-element').forEach(el => {
    if(mode === 'move') {
      interact(el).draggable(true).resizable(false);
    } else if(mode === 'resize') {
      interact(el).draggable(false).resizable({
        edges: { bottom: true, right: true },
        restrictEdges: { outer: 'parent' }
      });
    } else {
      interact(el).draggable(false).resizable(false);
    }
  });
}

function clampPosition(x, y, width, height, container) {
  const rect = container.getBoundingClientRect();
  const maxX = rect.width - width;
  const maxY = rect.height - height;
  return {
    x: Math.min(Math.max(x, 0), maxX),
    y: Math.min(Math.max(y, 0), maxY)
  };
}

function interactElement(el){
  const preview = document.getElementById('preview');
  interact(el).draggable({
    inertia: false,
    modifiers: [
      interact.modifiers.restrictRect({ restriction: 'parent' })
    ],
    listeners: { 
      start() {
        isDraggingOrResizing = true;
      },
      move(event){
        let x = parseFloat(el.style.left) + event.dx;
        let y = parseFloat(el.style.top) + event.dy;

        const clamped = clampPosition(x, y, el.offsetWidth, el.offsetHeight, preview);
        el.style.left = clamped.x + 'px';
        el.style.top = clamped.y + 'px';

        if(el === selected) {
          renderProps();
          generateCode();
        }
      },
      end() {
        isDraggingOrResizing = false;
      }
    }
  }).resizable({
    edges: { bottom: true, right: true },
    inertia: false,
    modifiers: [
      interact.modifiers.restrictEdges({ outer: 'parent' }),
      interact.modifiers.restrictSize({ min: { width: 20, height: 20 } })
    ],
    listeners: {
      start() {
        isDraggingOrResizing = true;
      },
      move(event){
        const previewRect = preview.getBoundingClientRect();
        let newWidth = event.rect.width;
        let newHeight = event.rect.height;

        const maxWidth = preview.clientWidth - parseFloat(el.style.left);
        const maxHeight = preview.clientHeight - parseFloat(el.style.top);
        if(newWidth > maxWidth) newWidth = maxWidth;
        if(newHeight > maxHeight) newHeight = maxHeight;

        el.style.width = newWidth + 'px';
        el.style.height = newHeight + 'px';

        if(el === selected) {
          renderProps();
          generateCode();
        }
      },
      end() {
        isDraggingOrResizing = false;
      }
    }
  });
}

function generateCode(){
  let code = 'local ScreenGui = Instance.new("ScreenGui")\n';
  [...document.querySelectorAll('.ui-element,[data-type="Folder"],[data-type="Model"]')].forEach(e => {
    const nm=e.dataset.name, t=e.dataset.type;
    code += `local ${nm} = Instance.new("${t}")\n`;
    if(!['Folder','Model'].includes(t)){
      const l=parseInt(e.style.left), tp=parseInt(e.style.top), w=parseInt(e.style.width), h=parseInt(e.style.height);
      const [r,g,b]=(e.dataset.color||'255,255,255').split(',').map(Number);
      code += `${nm}.Size = UDim2.new(0, ${w}, 0, ${h})\n${nm}.Position = UDim2.new(0, ${l}, 0, ${tp})\n`;
      code += `${nm}.BackgroundColor3 = Color3.fromRGB(${r},${g},${b})\n`;
    }
    if(e.dataset.text && /Text(Label|Button)/.test(t)) code += `${nm}.Text = "${e.dataset.text}"\n`;
    if(e.dataset.image) code += `${nm}.Image = "rbxassetid://${e.dataset.image}"\n`;
    code += `${nm}.Parent = ${e.dataset.parent}\n\n`;
  });
  document.getElementById('output').value = code;
}

document.getElementById('preview').addEventListener('click', clearSelection);
refresh()
</script>
</body>
</html>
